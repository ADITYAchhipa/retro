// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info
  name     String
  email    String  @unique
  password String?
  phone    String?
  avatar   String?

  // Role & Status
  role       UserRole @default(SEEKER)
  isVerified Boolean  @default(false)
  isActive   Boolean  @default(true)

  // Authentication
  authProvider AuthProvider @default(LOCAL)
  googleId     String?      @unique
  facebookId   String?      @unique

  // Address
  address Json?

  // Preferences
  preferences Json?

  // Profile
  profile Json?

  // Verification
  verification Json?

  // Ratings
  averageRating Float @default(0)
  ratingCount   Int   @default(0)
  ownerRating   Float @default(0)
  renterRating  Float @default(0)

  // Stats
  totalBookings Int      @default(0)
  totalListings Int      @default(0)
  joinedDate    DateTime @default(now())
  lastActive    DateTime @default(now())
  lastLogin     DateTime @default(now())

  // Tokens & Referrals
  referralCode  String? @unique
  earnedTokens  Int     @default(0)
  spentTokens   Int     @default(0)

  // Subscription
  subscriptionPlan SubscriptionPlan @default(FREE)
  subscriptionEnd  DateTime?

  // Relations
  properties     Property[]
  bookings       Booking[]
  reviews        Review[]
  receivedReviews Review[] @relation("ReviewTarget")
  notifications  Notification[]
  messages       Message[]
  conversations  ConversationParticipant[]

  @@map("users")
}

model Property {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Basic Info
  title       String
  description String
  type        PropertyType
  category    String
  status      PropertyStatus @default(ACTIVE)

  // Location
  address     String
  city        String
  state       String
  country     String
  zipCode     String?
  latitude    Float?
  longitude   Float?

  // Pricing
  basePrice    Float
  currency     String  @default("USD")
  pricePerDay  Float?
  pricePerWeek Float?
  pricePerMonth Float?

  // Details
  bedrooms   Int?
  bathrooms  Int?
  area       Float?
  capacity   Int?
  amenities  Json?
  rules      Json?
  images     Json?

  // Vehicle specific (if applicable)
  make         String?
  model        String?
  year         Int?
  mileage      Int?
  fuelType     String?
  transmission String?

  // Availability
  isAvailable     Boolean @default(true)
  availableFrom   DateTime?
  availableTo     DateTime?
  minimumStay     Int     @default(1)
  maximumStay     Int?

  // Ratings
  averageRating Float @default(0)
  ratingCount   Int   @default(0)
  totalBookings Int   @default(0)

  // Relations
  owner    User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId  String
  bookings Booking[]
  reviews  Review[]
  wishlist Wishlist[]

  @@map("properties")
}

model Booking {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Booking Details
  startDate DateTime
  endDate   DateTime
  status    BookingStatus @default(PENDING)

  // Pricing
  totalAmount Float
  currency    String @default("USD")
  baseAmount  Float
  taxAmount   Float  @default(0)
  feeAmount   Float  @default(0)

  // Guest Details
  guestCount Int @default(1)
  guestInfo  Json?

  // Payment
  paymentStatus PaymentStatus @default(PENDING)
  paymentId     String?
  refundAmount  Float?

  // Special Requests
  specialRequests String?
  notes          String?

  // Relations
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  reviews    Review[]

  @@map("bookings")
}

model Review {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Review Content
  rating  Int
  comment String?
  images  Json?

  // Review Type
  type ReviewType @default(PROPERTY)

  // Relations
  reviewer   User     @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewerId String
  target     User?    @relation("ReviewTarget", fields: [targetId], references: [id], onDelete: Cascade)
  targetId   String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String?
  booking    Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId  String?

  @@map("reviews")
}

model Wishlist {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  @@unique([userId, propertyId])
  @@map("wishlists")
}

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Conversation Details
  title      String?
  type       ConversationType @default(DIRECT)
  isActive   Boolean          @default(true)
  lastMessage String?
  lastMessageAt DateTime?

  // Relations
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Participant Details
  role         ParticipantRole @default(MEMBER)
  joinedAt     DateTime        @default(now())
  lastReadAt   DateTime?
  isActive     Boolean         @default(true)

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Message Content
  content     String
  messageType MessageType @default(TEXT)
  attachments Json?

  // Message Status
  isEdited  Boolean @default(false)
  isDeleted Boolean @default(false)

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId       String

  @@map("messages")
}

model Notification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Notification Content
  title   String
  message String
  type    NotificationType
  data    Json?

  // Status
  isRead   Boolean @default(false)
  readAt   DateTime?
  isActive Boolean @default(true)

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@map("notifications")
}

// Enums
enum UserRole {
  SEEKER
  OWNER
  ADMIN
}

enum AuthProvider {
  LOCAL
  GOOGLE
  FACEBOOK
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  PRO
}

enum PropertyType {
  HOUSE
  APARTMENT
  ROOM
  VEHICLE
  EQUIPMENT
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ReviewType {
  PROPERTY
  USER
}

enum ConversationType {
  DIRECT
  GROUP
  SUPPORT
}

enum ParticipantRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum NotificationType {
  BOOKING
  PAYMENT
  REVIEW
  MESSAGE
  SYSTEM
  PROMOTION
}
